AWSTemplateFormatVersion: '2010-09-09'
Description: 'S3 buckets for various use cases'

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, stg, prod]
    Description: Environment name

  Region:
    Type: String
    Default: us-east-1
    Description: AWS region for deployment

  Client:
    Type: String
    Default: gen-client5
    Description: Client name

  CostCenter:
    Type: String
    Default: '1003'
    Description: Cost center for billing tags

  BaseDomain:
    Type: String
    Default: genpactdemos.com
    Description: Base domain name

  RecTransExpiration:
    Type: Number
    Default: 2555
    Description: Recording transcripts expiration days

  RecTransITTransition:
    Type: Number
    Default: 90
    Description: Recording transcripts IT transition days

  RecTransGlacierTransition:
    Type: Number
    Default: 365
    Description: Recording transcripts Glacier transition days

  AbortIncomplete:
    Type: Number
    Default: 7
    Description: Abort incomplete multipart upload days

  ExpReportsExpiration:
    Type: Number
    Default: 180
    Description: Exported reports expiration days

  ScreenRecExpiration:
    Type: Number
    Default: 60
    Description: Screen recording expiration days

  VoicemailExpiration:
    Type: Number
    Default: 30
    Description: Voicemail expiration days

  LexBotExpiration:
    Type: Number
    Default: 180
    Description: Lex bot expiration days

  BucketLoggingExpiration:
    Type: Number
    Default: 180
    Description: Bucket logging expiration days

  VPCStackName:
    Type: String
    Description: Name of the VPC stack

Resources:
  # PRIMARY S3 BUCKET - Recordings and Transcripts
  RecordingsAndTranscriptsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'rec-trans-${Client}-${Region}-${Environment}'
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: recording-transcript
            Status: Enabled
            ExpirationInDays: !Ref RecTransExpiration
            Transitions:
              - TransitionInDays: !Ref RecTransITTransition
                StorageClass: INTELLIGENT_TIERING
              - TransitionInDays: !Ref RecTransGlacierTransition
                StorageClass: GLACIER
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: !Ref AbortIncomplete
      Tags:
        - Key: Name
          Value: !Sub 'rec-trans-${Client}-${Region}-${Environment}'
        - Key: environment
          Value: !Ref Environment
        - Key: costCenter
          Value: !Ref CostCenter
        - Key: appService
          Value: !Ref Client
        - Key: deployedBy
          Value: cloudformation

Outputs:
  RecordingsAndTranscriptsBucketName:
    Description: Recordings and Transcripts S3 Bucket Name
    Value: !Ref RecordingsAndTranscriptsBucket
    Export:
      Name: !Sub '${AWS::StackName}-RecordingsAndTranscriptsBucket'